<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Viajes Full Day Venezuela | Aventuras Inolvidables</title>
	<link rel="stylesheet" href="style.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>

<body>
	<header class="main-header">
		<div class="logo">Roloeviajes</div>
		<nav class="main-nav">
		</nav>
		<div id="auth-actions" class="me-3">
			<!-- Se completar치 con JS: login/register o usuario+logout -->
			<a href="./utilitarios/login.php" id="link-login" class="btn btn-sm btn-outline-primary">Entrar</a>
			<a href="./utilitarios/register.php" id="link-register" class="btn btn-sm btn-outline-secondary">Registrarse</a>
		</div>
		<div class="cart-icon" id="abrir-carrito">
			<i class="fas fa-shopping-cart"></i>
			<span id="contador-carrito">0</span>
		</div>
	</header>

	<main>
		<section id="paquetes" class="paquetes-container p-5">
		</section>
	</main>

	<aside class="carrito-panel" id="carrito-panel">
		<button class="cerrar-carrito" id="cerrar-carrito">&times;</button>
		<h3>游 Tu Reserva</h3>
		<ul id="lista-items-carrito" class="lista-items-carrito">
			<li class="carrito-vacio-msg">El carrito est치 vac칤o.</li>
		</ul>
		<div class="carrito-total">
			<strong>Total Estimado:</strong> <span id="carrito-total-monto">$0.00</span>
		</div>
		<button class="btn-finalizar">Finalizar Reserva</button>
	</aside>

	<div class="modal" id="modal-detalles">
		<div class="modal-content">
			<span class="close-button" id="cerrar-modal">&times;</span>
			<h3 id="modal-titulo">Cargando Detalles del Tour...</h3>
			<p id="modal-descripcion">Placeholder para la descripci칩n completa del tour.</p>
			<hr>
			<p><strong>Duraci칩n:</strong> <span id="modal-duracion">Full Day (10-12 horas)</span></p>
			<p><strong>Pr칩xima Fecha:</strong> <span id="modal-fecha">S치bado 25 de Enero</span></p>
			<button class="btn-reservar" id="modal-btn-reservar">Reservar este Tour</button>
		</div>
	</div>

	<section id="historial-pedidos" class="historial-pedidos">
		<h2>Historial de Pedidos Registrados</h2>
		<div class="pedidos-lista" id="pedidos-lista">
			<p>Cargando pedidos...</p>
		</div>
	</section>

	<footer class="main-footer">
		<p>&copy; 2025 VzlaAventura. Todos los derechos reservados.</p>
	</footer>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			// Definiciones de DOM
			let isLoggedIn = false;
			const listaPedidos = document.getElementById('pedidos-lista');
			const contadorCarrito = document.getElementById('contador-carrito');
			const listaCarrito = document.getElementById('lista-items-carrito');
			const carritoTotalMonto = document.getElementById('carrito-total-monto');
			const panelCarrito = document.getElementById('carrito-panel');
			const abrirCarritoBtn = document.getElementById('abrir-carrito');
			const cerrarCarritoBtn = document.getElementById('cerrar-carrito');
			const modalDetalles = document.getElementById('modal-detalles');
			const cerrarModalBtn = document.getElementById('cerrar-modal');
			const paquetesContainer = document.getElementById('paquetes');
			const modalBtnReservar = document.getElementById('modal-btn-reservar');
			const btnFinalizar = document.querySelector('.btn-finalizar');
			// Estado Global del Carrito
			let carrito = [];
			let toursDataCache = {};

			function renderizarTours(tours) {
				let html = '';
				if (tours.length === 0) {
					paquetesContainer.innerHTML = '<h2>No hay tours disponibles en este momento.</h2>';
					return;
				}

				// Renderiza el t칤tulo de la secci칩n
				tours.forEach(tour => {
					// Guarda la data en el cache para usarla en el modal/carrito sin m치s peticiones
					toursDataCache[tour.id_tour] = tour;

					html += `
                <article class="tour-card" data-tour-id="${tour.id_tour}" data-precio="${tour.precio}">
                    <img src="./images/${tour.imagen_placeholder}" alt="${tour.nombre}" class="tour-image">
                    <h3>${tour.nombre}</h3>
                    <p class="tour-precio">$${parseFloat(tour.precio).toFixed(2)} USD <small>p/p</small></p>
                    <div class="tour-actions">
                        <button class="btn-reservar" data-tour-id="${tour.id_tour}" data-precio="${tour.precio}">Reservar ahora</button>
                        <button class="btn-detalles" data-tour-id="${tour.id_tour}">Ver detalles</button>
                    </div>
                </article>
            `;
				});
				paquetesContainer.innerHTML = html;
			}

			async function comprobarSesion() {
				try {
					const r = await fetch('session_status.php');
					const js = await r.json();
					isLoggedIn = !!js.logged_in;
					const auth = document.getElementById('auth-actions');
					if (isLoggedIn) {
						auth.innerHTML = `<span class="me-2">Hola, ${js.username}</span><a href="./utilitarios/logout.php" class="btn btn-sm btn-outline-danger">Salir</a>`;
					} else {
						auth.innerHTML = `<a href="./utilitarios/login.php" class="btn btn-sm btn-outline-primary">Entrar</a>
                              <a href="./utilitarios/register.php" class="btn btn-sm btn-outline-secondary">Registrarse</a>`;
					}
				} catch (e) {
					console.error('No se pudo comprobar sesi칩n', e);
				}
			}

			btnFinalizar.addEventListener('click', async (e) => {
				if (!isLoggedIn) {
					// redirige al login
					window.location.href = './utilitarios/login.php';
					return;
				}
				enviarPedidoAlBackend();
			});

			async function comprobarSesion() {
				try {
					const r = await fetch('session_status.php');
					const js = await r.json();
					isLoggedIn = !!js.logged_in;
					const auth = document.getElementById('auth-actions');
					if (isLoggedIn) {
						// Mostrar link a admin si role === 'admin'
						const adminLink = js.role === 'admin' ? `<a href="./utilitarios/admin.php" class="btn btn-sm btn-outline-warning me-2">Admin</a>` : '';
						auth.innerHTML = `${adminLink}<span class="me-2">Hola, ${js.username}</span><a href="./utilitarios/logout.php" class="btn btn-sm btn-outline-danger">Salir</a>`;
					} else {
						auth.innerHTML = `<a href="./utilitarios/login.php" class="btn btn-sm btn-outline-primary">Entrar</a>
                              <a href="./utilitarios/register.php" class="btn btn-sm btn-outline-secondary">Registrarse</a>`;
					}
				} catch (e) {
					console.error('No se pudo comprobar sesi칩n', e);
				}
			}

			function agregarAlCarrito(tourId, precio) {
				// Usa el cache global para obtener la informaci칩n completa
				const tour = toursDataCache[tourId];
				if (!tour) return;

				carrito.push({
					id: tourId,
					nombre: tour.nombre,
					precio: parseFloat(precio)
				});

				actualizarCarrito();
				panelCarrito.classList.add('active');
			}

			async function cargarTours() {
				paquetesContainer.innerHTML = '<h2>Cargando nuestros tours...</h2>';
				try {
					const response = await fetch('./consultas/obtener_tours.php');
					const data = await response.json();

					if (data.success && data.tours) {
						renderizarTours(data.tours);
					} else {
						paquetesContainer.innerHTML = `<h2>Error al cargar los tours: ${data.message}</h2>`;
					}
				} catch (error) {
					console.error('Error de red al cargar tours:', error);
					paquetesContainer.innerHTML = '<h2>Fallo en la conexi칩n. No se pudieron cargar los tours.</h2>';
				}
			}

			// --- Funciones del Carrito ---
			function cargarHistorialPedidos() {
				listaPedidos.innerHTML = '<p>Consultando pedidos en el servidor...</p>';

				fetch('./consultas/obtener_pedidos.php')
					.then(response => response.json())
					.then(data => {
						if (data.success && data.pedidos.length > 0) {
							// Inicia con la cabecera
							let html = `
                            <div class="pedido-item pedido-header">
                                <span class="pedido-id">ID</span>
                                <span class="pedido-monto">Total</span>
                                <span class="pedido-cantidad">Tours</span>
                                <span class="pedido-fecha">Fecha</span>
                            </div>
                        `;

							// Itera sobre los pedidos y crea el HTML
							data.pedidos.forEach(pedido => {
								// Formato de fecha b치sico para mejor lectura
								const fecha = new Date(pedido.fecha_pedido).toLocaleDateString('es-VE', {
									year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
								});

								html += `
                                <div class="pedido-item">
                                    <span class="pedido-id">#${pedido.id_pedido}</span>
                                    <span class="pedido-monto">$${parseFloat(pedido.monto_total).toFixed(2)}</span>
                                    <span class="pedido-cantidad">${pedido.cantidad_items}</span>
                                    <span class="pedido-fecha">${fecha}</span>
                                </div>
                            `;
							});

							listaPedidos.innerHTML = html;

						} else if (data.success && data.pedidos.length === 0) {
							listaPedidos.innerHTML = '<p>A칰n no hay pedidos registrados.</p>';
						} else {
							listaPedidos.innerHTML = `<p style="color: red;">Error al cargar el historial: ${data.message || 'Verifique la conexi칩n a la base de datos.'}</p>`;
						}
					})
					.catch(error => {
						console.error('Error de red al cargar pedidos:', error);
						listaPedidos.innerHTML = '<p style="color: red;">Fallo en la comunicaci칩n con el servidor.</p>';
					});
			}

			/**
			 * @param {string} tourId - ID del tour a agregar (e.g., 'mochima').
			 * @param {number} precio - Precio del tour.
			 */
			function agregarAlCarrito(tourId, precio) {
				const tour = toursDataCache[tourId];
				if (!tour) return;

				// Simula la adici칩n simple de un tour
				carrito.push({
					id: tourId,
					nombre: tour.nombre,
					precio: parseFloat(precio)
				});

				// Actualiza la interfaz
				actualizarCarrito();
				panelCarrito.classList.add('active'); // Muestra el panel
			}

			/**
			 * Calcula el total, actualiza el contador y renderiza la lista de 칤tems.
			 */
			function actualizarCarrito() {
				// 1. C치lculo del Total
				const total = carrito.reduce((sum, item) => sum + item.precio, 0);

				// 2. Actualizaci칩n del Contador
				contadorCarrito.textContent = carrito.length;

				// 3. Renderizado de la Lista de 칈tems
				listaCarrito.innerHTML = '';
				if (carrito.length === 0) {
					listaCarrito.innerHTML = '<li class="carrito-vacio-msg">El carrito est치 vac칤o.</li>';
				} else {
					carrito.forEach(item => {
						const li = document.createElement('li');
						li.className = 'carrito-item';
						li.innerHTML = `
                            <span>${item.nombre}</span>
                            <span>$${item.precio.toFixed(2)}</span>
                        `;
						listaCarrito.appendChild(li);
					});
				}

				// 4. Actualizaci칩n del Total
				carritoTotalMonto.textContent = `$${total.toFixed(2)}`;
			}

			// --- Funciones del Modal ---

			/**
			 * @param {string} tourId - ID del tour cuyos detalles se mostrar치n.
			 */
			function mostrarModal(tourId) {
				// Usa el cache global para obtener la informaci칩n completa
				const tour = toursDataCache[tourId];

				if (tour) {
					document.getElementById('modal-titulo').textContent = tour.nombre;
					document.getElementById('modal-descripcion').textContent = tour.descripcion;
					document.getElementById('modal-duracion').textContent = tour.duracion;
					document.getElementById('modal-fecha').textContent = tour.fecha_disponible;

					modalBtnReservar.dataset.tourId = tourId;
					modalBtnReservar.dataset.precio = tour.precio;

					modalDetalles.classList.add('active');
				}
			}

			function cerrarModal() {
				modalDetalles.classList.remove('active');
			}

			function enviarPedidoAlBackend() {
				if (carrito.length === 0) {
					alert('Tu carrito est치 vac칤o. Agrega un tour antes de finalizar la reserva.');
					return;
				}

				// Obtener el total calculado y la CANTIDAD DE 칈TEMS
				const total = carrito.reduce((sum, item) => sum + item.precio, 0).toFixed(2);
				const cantidad = carrito.length; // La cantidad de 칤tems es la longitud del array carrito

				// Preparar los datos para el env칤o
				const dataToSend = new URLSearchParams();
				dataToSend.append('total', total);
				dataToSend.append('cantidad', cantidad); // 춰Nuevo dato a enviar!

				// Usando Fetch API para enviar los datos
				fetch('./consultas/procesar_pedido.php', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
					// Enviar ambos datos en el cuerpo
					body: dataToSend
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							// 칄xito: Notificar e informar la cantidad
							alert(`춰Reserva Finalizada! El pedido #${data.id_pedido} fue registrado por $${total} USD con ${cantidad} tours. Pronto te contactaremos.`);
							carrito = []; // Vac칤a el carrito
							actualizarCarrito(); // Actualiza el contador y la vista
							panelCarrito.classList.remove('active'); // Cierra el panel
							cargarHistorialPedidos();
						} else {
							// Error en el servidor o data inv치lida
							alert(`Error al procesar la reserva: ${data.message}`);
						}
					})
					.catch(error => {
						console.error('Error de red o del servidor:', error);
						alert('Ocurri칩 un error de conexi칩n. Intenta de nuevo m치s tarde.');
					});
			}

			// --- Manejo de Eventos (Event Listeners) ---

			// 1. Eventos del Carrito y Modal en la Secci칩n Principal
			paquetesContainer.addEventListener('click', (event) => {
				const target = event.target;

				if (target.classList.contains('btn-reservar')) {
					const tourId = target.dataset.tourId;
					const precio = target.dataset.precio;
					agregarAlCarrito(tourId, precio);
				} else if (target.classList.contains('btn-detalles')) {
					const tourId = target.dataset.tourId;
					mostrarModal(tourId);
				}
			});

			// 2. Eventos del Panel del Carrito (Abrir/Cerrar)
			abrirCarritoBtn.addEventListener('click', () => {
				panelCarrito.classList.add('active');
			});

			cerrarCarritoBtn.addEventListener('click', () => {
				panelCarrito.classList.remove('active');
			});

			// 3. Eventos del Modal de Detalles (Cerrar y Reservar)
			cerrarModalBtn.addEventListener('click', cerrarModal);

			// Cierra el modal al hacer clic fuera del contenido
			modalDetalles.addEventListener('click', (event) => {
				if (event.target === modalDetalles) {
					cerrarModal();
				}
			});

			// Bot칩n de Reservar dentro del Modal
			modalBtnReservar.addEventListener('click', (event) => {
				const tourId = event.target.dataset.tourId;
				const precio = event.target.dataset.precio;
				agregarAlCarrito(tourId, precio);
				cerrarModal(); // Cierra el modal despu칠s de agregar al carrito
			});

			btnFinalizar.addEventListener('click', enviarPedidoAlBackend);

			// Inicializaci칩n al cargar la p치gina
			comprobarSesion();
			cargarTours();
			actualizarCarrito();
			cargarHistorialPedidos();
		});
	</script>
</body>

</html>