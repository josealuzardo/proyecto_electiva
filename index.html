<!DOCTYPE html>
<html lang="es">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Viajes Full Day Venezuela | Aventuras Inolvidables</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
		integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
	<link rel="stylesheet" href="./style.css">
</head>

<body>
	<header class="main-header">
		<div class="logo">Roloeviajes</div>

		<div id="auth-actions" class="me-3">
			<a href="./utilitarios/login.php" id="link-login" class="btn btn-sm btn-outline-light">Entrar</a>
			<a href="./utilitarios/register.php" id="link-register" class="btn btn-sm btn-warning text-dark">Registrarse</a>
		</div>

		<div class="cart-icon" id="abrir-carrito">
			<i class="fas fa-shopping-cart"></i>
			<span id="contador-carrito">0</span>
		</div>
		<button class="chatbot-fab" id="open-chatbot-btn">
			Chat
		</button>
	</header>

	<main>
		<section class="hero h-100" style="background: url('./images/placeholder-hero.jpg') center/cover no-repeat;">
		</section>
		<section id="about-us" class="about-us-container container py-5">
			<h2 class="text-center mb-4 text-primary fw-bold">Sobre Nosotros</h2>
			<div class="row pt-5 justify-content-between">
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						                        <h3 class="my-3 text-center text-muted">Nuestra Historia</h3>
						                        <hr>
						                        <p id="historia-text" class="text-secondary text-center p-3">Roloeviajes naci贸 de la pasi贸n por mostrar las maravillas de
						                            Venezuela al mundo. Desde 2024, nos hemos
						                            dedicado a crear experiencias de viaje 煤nicas y memorables, conectando a los viajeros con la belleza
						                            natural y la rica cultura de nuestro pa铆s.</p>					</div>
				</div>
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						<h3 class="my-3 text-center text-muted">Misi贸n</h3>
						<hr>
						<p class="text-secondary text-center p-3">Ofrecer viajes que no solo deslumbren por sus paisajes, sino que
							tambi茅n enriquezcan el alma,
							promoviendo un turismo responsable y sostenible que beneficie a las comunidades locales y preserve
							nuestros
							tesoros naturales para las futuras generaciones.</p>
					</div>
				</div>
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						<h3 class="my-3 text-center text-muted">Visi贸n</h3>
						<hr>
						<p class="text-secondary text-center p-3">Ser la agencia de viajes l铆der en Venezuela, reconocida por
							nuestra excelencia, innovaci贸n y compromiso
							con la autenticidad y la sostenibilidad. Queremos que cada viajero se convierta en un embajador de las
							maravillas de nuestro pa铆s.</p>
					</div>
				</div>
			</div>
		</section>

		<section id="why-us" class="why-us-container container py-5">
			<h2 class="text-center mb-4 text-primary fw-bold">驴Por Qu茅 Viajar con Nosotros?</h2>
			<div class="row pt-5 justify-content-between">
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						<h3 class="my-3 text-center text-muted">Experiencias Aut茅nticas</h3>
						<hr>
						<p class="text-secondary text-center p-3">Dise帽amos nuestros tours para que vivas una inmersi贸n cultural
							real, lejos de las rutas tur铆sticas
							convencionales. Conoce la verdadera Venezuela, su gente y sus costumbres.</p>
					</div>
				</div>
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						<h3 class="my-3 text-center text-muted">Compromiso con la calidad</h3>
						<hr>
						<p class="text-secondary text-center p-3">Desde la planificaci贸n hasta el regreso a casa, nuestro equipo se
							asegura de que cada detalle est茅
							cubierto. Viaja con la tranquilidad de saber que est谩s en las mejores manos.</p>
					</div>
				</div>
				<div class="col-md-3 mb-4 shadow rounded-4 m-1">
					<div class="about-us-card h-100">
						<h3 class="my-3 text-center text-muted">Gu铆as Expertos y Apasionados</h3>
						<hr>
						<p class="text-secondary text-center p-3">Nuestros gu铆as no solo conocen los destinos, sino que los aman. Su
							pasi贸n y conocimiento te permitir谩n
							descubrir los secretos mejor guardados de cada lugar.</p>
					</div>
				</div>
			</div>
		</section>
		<h2 class="text-center mb-4 text-primary fw-bold">Nuestros paquetes</h2>
		<section id="paquetes" class="paquetes-container p-5">
		</section>
	</main>

	<aside class="carrito-panel" id="carrito-panel">
		<button class="cerrar-carrito" id="cerrar-carrito">&times;</button>
		<h3> Tu Reserva</h3>
		<ul id="lista-items-carrito" class="lista-items-carrito">
			<li class="carrito-vacio-msg">El carrito est谩 vac铆o.</li>
		</ul>
		<div class="carrito-total">
			<strong>Total Estimado:</strong> <span id="carrito-total-monto">$0.00</span>
		</div>
		<button class="btn-finalizar">Finalizar Reserva</button>
	</aside>

	<div class="modal" id="login-prompt-modal">
		<div class="modal-content">
			<span class="close-button" id="cerrar-login-prompt-modal">&times;</span>
			<h3>Necesitas iniciar sesi贸n</h3>
			<p>Para finalizar tu reserva, por favor inicia sesi贸n o reg铆strate.</p>
			<button class="btn btn-primary" id="go-to-login-btn">Ir a Iniciar Sesi贸n</button>
		</div>
	</div>

	<div class="modal" id="chatbot-modal">
		<div class="modal-content chatbot-content">
			<div class="chatbot-header">
				<h3>Chatbot de Ayuda</h3>
				<button class="close-button" id="cerrar-chatbot-modal">&times;</button>
			</div>
			<div class="chatbot-body" id="chatbot-messages">
				<!-- Chat messages will be appended here -->
				<div class="message bot-message">Hola, soy tu asistente virtual. 驴En qu茅 puedo ayudarte?</div>
			</div>
			<div class="chatbot-footer">
				<input type="text" id="chatbot-input" class="form-control" placeholder="Escribe tu mensaje...">
				            <button id="chatbot-send-btn" class="btn btn-secondary">Enviar</button>			</div>
		</div>
	</div>

	<div class="modal" id="modal-detalles">
		<div class="modal-content">
			<span class="close-button" id="cerrar-modal">&times;</span>
			<h3 id="modal-titulo">Cargando Detalles del Tour...</h3>
			<p id="modal-descripcion">Placeholder para la descripci贸n completa del tour.</p>
			<hr>
			<p><strong>Duraci贸n:</strong> <span id="modal-duracion">Full Day (10-12 horas)</span></p>
			<p><strong>Pr贸xima Fecha:</strong> <span id="modal-fecha">S谩bado 25 de Enero</span></p>
			<button class="btn btn-success" id="modal-btn-reservar">Reservar este Tour</button>
		</div>
	</div>

	<section id="historial-pedidos" class="historial-pedidos shadow rounded">
		<h2>Historial de Pedidos Registrados</h2>
		<div class="pedidos-lista" id="pedidos-lista">
			<p>Cargando pedidos...</p>
		</div>
	</section>

	<footer class="main-footer">
		<p>&copy; 2025 VzlaAventura. Todos los derechos reservados.</p>
	</footer>

	<button class="chatbot-fab" id="open-chatbot-btn">
		Chatbot
	</button>

	<script>
		document.addEventListener('DOMContentLoaded', () => {
			let isLoggedIn = false;
			const listaPedidos = document.getElementById('pedidos-lista');
			const contadorCarrito = document.getElementById('contador-carrito');
			const listaCarrito = document.getElementById('lista-items-carrito');
			const carritoTotalMonto = document.getElementById('carrito-total-monto');
			const panelCarrito = document.getElementById('carrito-panel');
			const abrirCarritoBtn = document.getElementById('abrir-carrito');
			const cerrarCarritoBtn = document.getElementById('cerrar-carrito');
			const modalDetalles = document.getElementById('modal-detalles');
			const cerrarModalBtn = document.getElementById('cerrar-modal');
			const paquetesContainer = document.getElementById('paquetes');
			const modalBtnReservar = document.getElementById('modal-btn-reservar');
			const btnFinalizar = document.querySelector('.btn-finalizar');
			let carrito = [];
			let toursDataCache = {};
			const goToLoginBtn = document.getElementById('go-to-login-btn');

			const chatbotModal = document.getElementById('chatbot-modal');
			const openChatbotBtn = document.getElementById('open-chatbot-btn');
			const cerrarChatbotModalBtn = document.getElementById('cerrar-chatbot-modal');
			const chatbotMessages = document.getElementById('chatbot-messages');
			const chatbotInput = document.getElementById('chatbot-input');
			const chatbotSendBtn = document.getElementById('chatbot-send-btn');

			// Event listeners for chatbot modal
			openChatbotBtn.addEventListener('click', () => {
				chatbotModal.classList.add('active');
			});

			cerrarChatbotModalBtn.addEventListener('click', () => {
				chatbotModal.classList.remove('active');
			});

			chatbotModal.addEventListener('click', (event) => {
				if (event.target === chatbotModal) {
					chatbotModal.classList.remove('active');
				}
			});

			// Function to add a message to the chat
			function addMessage(text, sender) {
				const messageDiv = document.createElement('div');
				messageDiv.classList.add('message', `${sender}-message`);
				messageDiv.textContent = text;
				chatbotMessages.appendChild(messageDiv);
				chatbotMessages.scrollTop = chatbotMessages.scrollHeight; // Scroll to bottom
			}

			// Chatbot logic (keyword-based)
			function getChatbotResponse(message) {
				const lowerCaseMessage = message.toLowerCase();

				if (lowerCaseMessage.includes('hola') || lowerCaseMessage.includes('saludo')) {
					return '隆Hola! 驴En qu茅 puedo ayudarte hoy?';
				    } else if (lowerCaseMessage.includes('tours') || lowerCaseMessage.includes('paquetes')) {
				        let tourList = '隆Claro! Aqu铆 tienes algunos de nuestros tours disponibles:\n';
				        if (Object.keys(toursDataCache).length > 0) {
				            for (const tourId in toursDataCache) {
				                tourList += `- ${toursDataCache[tourId].nombre} ($${parseFloat(toursDataCache[tourId].precio).toFixed(2)} USD)\n`;
				            }
				            tourList += 'Puedes encontrar m谩s detalles en la secci贸n "Nuestros paquetes".';
				        } else {
				            tourList = 'Lo siento, no pude cargar la lista de tours en este momento. Por favor, visita la secci贸n "Nuestros paquetes" para m谩s informaci贸n.';
				        }
				        return tourList;				} else if (lowerCaseMessage.includes('contacto') || lowerCaseMessage.includes('ayuda')) {
					return 'Puedes contactarnos a trav茅s de nuestro correo electr贸nico info@roloeviajes.com o llamarnos al +58-212-555-1234.';
				} else if (lowerCaseMessage.includes('gracias')) {
					return 'De nada. 隆Que tengas un excelente d铆a!';
				} else if (lowerCaseMessage.includes('historia') || lowerCaseMessage.includes('mision') || lowerCaseMessage.includes('vision')) {
					return 'Puedes encontrar m谩s informaci贸n sobre nuestra historia, misi贸n y visi贸n en la secci贸n "Sobre Nosotros".';
				} else {
					return 'Lo siento, no entiendo tu pregunta. Por favor, intenta con palabras clave como "tours", "contacto", "historia".';
				}
			}

			// Handle sending messages
			chatbotSendBtn.addEventListener('click', () => {
				const userMessage = chatbotInput.value.trim();
				if (userMessage) {
					addMessage(userMessage, 'user');
					chatbotInput.value = '';

					// Get chatbot response
					setTimeout(() => {
						const botResponse = getChatbotResponse(userMessage);
						addMessage(botResponse, 'bot');
					}, 500);
				}
			});

			// Allow sending message with Enter key
			chatbotInput.addEventListener('keypress', (event) => {
				if (event.key === 'Enter') {
					chatbotSendBtn.click();
				}
			});

			function renderizarTours(tours) {
				let html = '';
				if (tours.length === 0) {
					paquetesContainer.innerHTML = '<h2>No hay tours disponibles en este momento.</h2>';
					return;
				}

				tours.forEach(tour => {
					toursDataCache[tour.id_tour] = tour;

					html += `
                <article class="tour-card" data-tour-id="${tour.id_tour}" data-precio="${tour.precio}">
                    <img src="./images/${tour.imagen_placeholder}" alt="${tour.nombre}" class="tour-image">
                    <h3>${tour.nombre}</h3>
                    <p class="tour-precio">$${parseFloat(tour.precio).toFixed(2)} USD <small>p/p</small></p>
                    <div class="tour-actions">
                        <button class="btn-reservar" data-tour-id="${tour.id_tour}" data-precio="${tour.precio}">Reservar ahora</button>
                        <button class="btn-detalles" data-tour-id="${tour.id_tour}">Ver detalles</button>
                    </div>
                </article>
            `;
				});
				paquetesContainer.innerHTML = html;
			}

			async function comprobarSesion() {
				try {
					const r = await fetch('session_status.php');
					const js = await r.json();
					isLoggedIn = !!js.logged_in;
					const auth = document.getElementById('auth-actions');
					if (isLoggedIn) {
						auth.innerHTML = `<span class="me-2">Hola, ${js.username}</span><a href="./utilitarios/logout.php" class="btn btn-sm btn-outline-danger">Salir</a>`;
					} else {
						auth.innerHTML = `<a href="./utilitarios/login.php" class="btn btn-sm btn-outline-primary">Entrar</a>
                              <a href="./utilitarios/register.php" class="btn btn-sm btn-outline-secondary">Registrarse</a>`;
					}
				} catch (e) {
					console.error('No se pudo comprobar sesi贸n', e);
				}
			}

			btnFinalizar.addEventListener('click', async (e) => {
				if (!isLoggedIn) {
					window.location.href = './utilitarios/login.php';
					return;
				}
				enviarPedidoAlBackend();
			});

			async function comprobarSesion() {
				try {
					const r = await fetch('session_status.php');
					const js = await r.json();
					isLoggedIn = !!js.logged_in;
					const auth = document.getElementById('auth-actions');
					if (isLoggedIn) {
						const adminLink = js.role === 'admin' ? `<a href="./utilitarios/admin.php" class="btn btn-sm btn-outline-warning me-2">Admin</a>` : '';
						auth.innerHTML = `${adminLink}<span class="me-2">Hola, ${js.username}</span><a href="./utilitarios/logout.php" class="btn btn-sm btn-outline-danger">Salir</a>`;
					} else {
						auth.innerHTML = `<a href="./utilitarios/login.php" class="btn btn-sm btn-outline-primary">Entrar</a>
                              <a href="./utilitarios/register.php" class="btn btn-sm btn-outline-secondary">Registrarse</a>`;
					}
				} catch (e) {
					console.error('No se pudo comprobar sesi贸n', e);
				}
			}

			function agregarAlCarrito(tourId, precio) {
				const tour = toursDataCache[tourId];
				if (!tour) return;

				carrito.push({
					id: tourId,
					nombre: tour.nombre,
					precio: parseFloat(precio)
				});

				actualizarCarrito();
				panelCarrito.classList.add('active');
			}

			async function cargarTours() {
				paquetesContainer.innerHTML = '<h2>Cargando nuestros tours...</h2>';
				try {
					const response = await fetch('./consultas/obtener_tours.php');
					const data = await response.json();

					if (data.success && data.tours) {
						renderizarTours(data.tours);
					} else {
						paquetesContainer.innerHTML = `<h2>Error al cargar los tours: ${data.message}</h2>`;
					}
				} catch (error) {
					console.error('Error de red al cargar tours:', error);
					paquetesContainer.innerHTML = '<h2>Fallo en la conexi贸n. No se pudieron cargar los tours.</h2>';
				}
			}

			function cargarHistorialPedidos() {
				listaPedidos.innerHTML = '<p>Consultando pedidos en el servidor...</p>';

				fetch('./consultas/obtener_pedidos.php')
					.then(response => response.json())
					.then(data => {
						if (data.success && data.pedidos.length > 0) {
							let html = `
                            <div class="pedido-item pedido-header">
                                <span class="pedido-id">ID</span>
                                <span class="pedido-monto">Total</span>
                                <span class="pedido-cantidad">Tours</span>
                                <span class="pedido-fecha">Fecha</span>
                            </div>
                        `;

							data.pedidos.forEach(pedido => {
								const fecha = new Date(pedido.fecha_pedido).toLocaleDateString('es-VE', {
									year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
								});

								html += `
                                <div class="pedido-item">
                                    <span class="pedido-id">#${pedido.id_pedido}</span>
                                    <span class="pedido-monto">$${parseFloat(pedido.monto_total).toFixed(2)}</span>
                                    <span class="pedido-cantidad">${pedido.cantidad_items}</span>
                                    <span class="pedido-fecha">${fecha}</span>
                                </div>
                            `;
							});

							listaPedidos.innerHTML = html;

						} else if (data.success && data.pedidos.length === 0) {
							listaPedidos.innerHTML = '<p>A煤n no hay pedidos registrados.</p>';
						} else {
							listaPedidos.innerHTML = `<p style="color: red;">Error al cargar el historial: ${data.message || 'Verifique la conexi贸n a la base de datos.'}</p>`;
						}
					})
					.catch(error => {
						console.error('Error de red al cargar pedidos:', error);
						listaPedidos.innerHTML = '<p style="color: red;">Fallo en la comunicaci贸n con el servidor.</p>';
					});
			}

			function agregarAlCarrito(tourId, precio) {
				const tour = toursDataCache[tourId];
				if (!tour) return;

				carrito.push({
					id: tourId,
					nombre: tour.nombre,
					precio: parseFloat(precio)
				});

				actualizarCarrito();
				panelCarrito.classList.add('active'); // Muestra el panel
			}

			function actualizarCarrito() {
				const total = carrito.reduce((sum, item) => sum + item.precio, 0);
				contadorCarrito.textContent = carrito.length;
				listaCarrito.innerHTML = '';
				if (carrito.length === 0) {
					listaCarrito.innerHTML = '<li class="carrito-vacio-msg">El carrito est谩 vac铆o.</li>';
				} else {
					carrito.forEach(item => {
						const li = document.createElement('li');
						li.className = 'carrito-item';
						li.innerHTML = `
                            <span>${item.nombre}</span>
                            <span>$${item.precio.toFixed(2)}</span>
                        `;
						listaCarrito.appendChild(li);
					});
				}

				carritoTotalMonto.textContent = `$${total.toFixed(2)}`;
			}
			function mostrarModal(tourId) {
				const tour = toursDataCache[tourId];

				if (tour) {
					document.getElementById('modal-titulo').textContent = tour.nombre;
					document.getElementById('modal-descripcion').textContent = tour.descripcion;
					document.getElementById('modal-duracion').textContent = tour.duracion;
					document.getElementById('modal-fecha').textContent = tour.fecha_disponible;

					modalBtnReservar.dataset.tourId = tourId;
					modalBtnReservar.dataset.precio = tour.precio;

					modalDetalles.classList.add('active');
				}
			}

			function cerrarModal() {
				modalDetalles.classList.remove('active');
			}

			function enviarPedidoAlBackend() {
				if (carrito.length === 0) {
					alert('Tu carrito est谩 vac铆o. Agrega un tour antes de finalizar la reserva.');
					return;
				}

				const total = carrito.reduce((sum, item) => sum + item.precio, 0).toFixed(2);
				const cantidad = carrito.length;

				const dataToSend = new URLSearchParams();
				dataToSend.append('total', total);
				dataToSend.append('cantidad', cantidad);

				fetch('./consultas/procesar_pedido.php', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
					body: dataToSend
				})
					.then(response => response.json())
					.then(data => {
						if (data.success) {
							alert(`隆Reserva Finalizada! El pedido #${data.id_pedido} fue registrado por $${total} USD con ${cantidad} tours. Pronto te contactaremos.`);
							carrito = [];
							actualizarCarrito();
							panelCarrito.classList.remove('active');
							cargarHistorialPedidos();
						} else {
							alert(`Error al procesar la reserva: ${data.message}`);
						}
					})
					.catch(error => {
						console.error('Error de red o del servidor:', error);
						alert('Ocurri贸 un error de conexi贸n. Intenta de nuevo m谩s tarde.');
					});
			}
			paquetesContainer.addEventListener('click', (event) => {
				const target = event.target;

				if (target.classList.contains('btn-reservar')) {
					const tourId = target.dataset.tourId;
					const precio = target.dataset.precio;
					agregarAlCarrito(tourId, precio);
				} else if (target.classList.contains('btn-detalles')) {
					const tourId = target.dataset.tourId;
					mostrarModal(tourId);
				}
			});

			abrirCarritoBtn.addEventListener('click', () => {
				panelCarrito.classList.add('active');
			});

			cerrarCarritoBtn.addEventListener('click', () => {
				panelCarrito.classList.remove('active');
			});

			cerrarModalBtn.addEventListener('click', cerrarModal);

			modalDetalles.addEventListener('click', (event) => {
				if (event.target === modalDetalles) {
					cerrarModal();
				}
			});

			modalBtnReservar.addEventListener('click', (event) => {
				const tourId = event.target.dataset.tourId;
				const precio = event.target.dataset.precio;
				agregarAlCarrito(tourId, precio);
				cerrarModal();
			});

			btnFinalizar.addEventListener('click', enviarPedidoAlBackend);

			comprobarSesion();
			cargarTours();
			actualizarCarrito();
			cargarHistorialPedidos();
		});
	</script>
</body>

</html>